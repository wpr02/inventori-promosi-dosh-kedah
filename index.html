<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Inventori DOSH Kedah</title>
    <style>
        :root { --primary: #003366; --accent: #27ae60; --admin: #8e44ad; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 480px; }
        .header { text-align: center; cursor: pointer; margin-bottom: 15px; }
        #clock { background: #eee; padding: 8px; border-radius: 8px; font-weight: bold; font-size: 13px; margin: 10px 0; text-align: center; }
        .alert { background: #fff5f5; border-left: 5px solid #e74c3c; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: none; width: 100%; max-width: 480px; box-sizing: border-box; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: var(--primary); font-size: 14px; }
        select, input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-user { background: var(--accent); }
        .btn-admin { background: var(--admin); margin-top: 5px; }
        #adminPanel { display: none; background: #fef9ff; padding: 20px; border-radius: 15px; margin-top: 25px; border: 2px dashed var(--admin); }
    </style>
</head>
<body>

    <div id="alertBox" class="alert">
        <h4 style="margin:0; color:#e74c3c;">‚ö†Ô∏è STOK RENDAH:</h4>
        <ul id="lowStockList" style="margin:5px 0; font-size:13px;"></ul>
    </div>

    <div class="container">
        <div class="header" onclick="toggleAdmin()">
            <h2 style="color:var(--primary); margin:0;">DOSH KEDAH</h2>
            <div id="clock">Memuatkan masa...</div>
        </div>

        <div id="userForm">
            <label>Nama Pengambil:</label>
            <select id="userName"><option>Sila tunggu...</option></select>
            <label>Seksyen:</label>
            <select id="userSection"><option>Sila tunggu...</option></select>
            <label>Pilih Barang:</label>
            <select id="itemSelect"><option>Sila tunggu...</option></select>
            <label>Kuantiti Ambil:</label>
            <input type="number" id="qty" value="1" min="1">
            <button class="btn-user" id="btnUser" onclick="prosesStok('tolak')">REKOD PENGAMBILAN</button>
        </div>

        <div id="adminPanel">
            <h3 style="color:var(--admin); text-align:center;">üîê Mod Admin</h3>
            <label>Barang (Restock):</label>
            <select id="itemAdmin"></select>
            <label>Kuantiti Masuk:</label>
            <input type="number" id="qtyAdmin" value="10">
            <button class="btn-admin" onclick="prosesStok('tambah')">TAMBAH STOK</button>
            <hr>
            <label>Emel Laporan Analisa:</label>
            <input type="email" id="adminEmail" placeholder="nama@dosh.gov.my">
            <button onclick="janaLaporan()" style="background:#34495e;">HANTAR LAPORAN KE EMEL</button>
        </div>
        <div id="status" style="text-align:center; font-size:12px; margin-top:15px; color:#888;">Sedia.</div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwIn3DpwnZdtgfbV6rjsZNU8iJ5G22CFlbaojG1sfP-Tdf8Pqp2IZW7qc3N_3qcM9y9/exec";
        const ADMIN_PASS = "1234"; 

        function updateClock() {
            const kini = new Date();
            const hari = ["Ahad", "Isnin", "Selasa", "Rabu", "Khamis", "Jumaat", "Sabtu"];
            const bulan = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogs", "Sep", "Okt", "Nov", "Dis"];
            document.getElementById('clock').innerHTML = `${hari[kini.getDay()]}, ${kini.getDate()} ${bulan[kini.getMonth()]} ${kini.getFullYear()} | ${kini.toLocaleTimeString()}`;
        }
        setInterval(updateClock, 1000);

        async function loadData() {
            try {
                const res = await (await fetch(API_URL)).json();
                isiSelect('userName', res.kakitangan);
                isiSelect('userSection', res.seksyen);
                
                const itemSelect = document.getElementById('itemSelect');
                const itemAdmin = document.getElementById('itemAdmin');
                itemSelect.innerHTML = itemAdmin.innerHTML = '<option value="">-- Pilih Barang --</option>';
                
                let low = [];
                res.stok.slice(1).forEach(row => {
                    if(row[1]) {
                        itemSelect.add(new Option(`${row[1]} (Baki: ${row[2]})`, row[1]));
                        itemAdmin.add(new Option(row[1], row[1]));
                        if(row[2] <= 5) low.push(`<li>${row[1]} (Baki: ${row[2]})</li>`);
                    }
                });
                if(low.length > 0) {
                    document.getElementById('alertBox').style.display = 'block';
                    document.getElementById('lowStockList').innerHTML = low.join('');
                }
            } catch (e) { document.getElementById('status').innerText = "Ralat data!"; }
        }

        function isiSelect(id, data) {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">-- Pilih --</option>';
            data.forEach(d => el.add(new Option(d, d)));
        }

        function toggleAdmin() {
            if(prompt("Katalaluan Admin:") === ADMIN_PASS) document.getElementById('adminPanel').style.display = 'block';
        }

        async function prosesStok(jenis) {
            const payload = {
                type: jenis,
                userName: jenis === 'tambah' ? 'ADMIN' : document.getElementById('userName').value,
                userSection: jenis === 'tambah' ? 'PENGURUSAN' : document.getElementById('userSection').value,
                itemName: document.getElementById(jenis === 'tambah' ? 'itemAdmin' : 'itemSelect').value,
                quantity: document.getElementById(jenis === 'tambah' ? 'qtyAdmin' : 'qty').value
            };
            if(!payload.itemName || !payload.quantity) return alert("Lengkapkan maklumat!");
            await hantarData(payload);
        }

        async function janaLaporan() {
            const email = document.getElementById('adminEmail').value;
            if(!email) return alert("Masukkan emel!");
            await hantarData({ action: "jana_laporan", emailPenerima: email });
        }

        async function hantarData(data) {
            document.getElementById('status').innerText = "Memproses...";
            try {
                const r = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
                alert(await r.text());
                location.reload();
            } catch (e) { alert("Gagal!"); }
        }

        loadData();
    </script>
</body>
</html>
